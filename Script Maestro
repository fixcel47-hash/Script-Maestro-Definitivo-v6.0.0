#!/usr/bin/env bash

# =================================================================================
# INSTALADOR AUTÓNOMO FINAL (v4.0.0)
# - Sin Token de Instalación.
# - Sustitución segura de claves (prevención de errores YAML).
# - Incluye todas las URLs de descarga de plantillas de GitHub.
# - Incluye la lógica de inicialización de Chatwoot.
# =================================================================================

# ------------------------------
# 1. Configuración de Variables
# ------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# TUS VARIABLES (HARDCODEADAS para ejecución sin interacción)
DOCKER_DIR="/home/docker"
COMMON_PASSWORD="Adel14881599"        
SECRET_KEY="wKStf8R8fAt7W78olV8D8kU5rdiqr31O"
BASE_DOMAIN="queennovedad.shop"

# Definición de herramientas y subdominios (Orden: Base -> Servicios)
declare -a ALL_TOOLS=("traefik" "portainer" "redis" "postgres" "n8n" "evoapi" "chatwoot")
declare -gA SUBDOMAINS=(
    [traefik]="proxy" [portainer]="admin" [redis]="redis" [postgres]="postgres" 
    [n8n]="n8" [evoapi]="evoapi" [chatwoot]="chat"
)

# URLs de descarga (URLs de GitHub proporcionadas)
declare -gA STACK_URLS=(
    [traefik]="https://github.com/user-attachments/files/22956506/traefik-stack.yml"
    [portainer]="https://github.com/user-attachments/files/22956492/portainer-stack.yml"
    [redis]="https://github.com/user-attachments/files/22956503/redis-stack.yml"
    [postgres]="https://github.com/user-attachments/files/22956495/postgres-stack.yml"
    [n8n]="https://github.com/user-attachments/files/22956487/n8n-stack.yml"
    [evoapi]="https://github.com/user-attachments/files/22956481/evoapi-stack.yml"
    [chatwoot]="https://github.com/user-attachments/files/22956465/chatwoot-stack.yml"
)


# ------------------------------
# 2. Funciones Auxiliares
# ------------------------------
show_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
show_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
show_error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
execute() { local cmd="$1"; show_info "-> Ejecutando: $cmd"; eval "$cmd"; if [ $? -ne 0 ]; then show_error "Comando falló con código $?: $cmd"; fi; }

# Función de instalación inicial
install_dependencies() {
    show_info "Verificando e instalando dependencias (Docker y Swarm)..."
    if ! command -v docker &> /dev/null; then
        execute "apt update"
        execute "apt install -y curl docker.io docker-compose jq"
        execute "systemctl start docker"
        execute "systemctl enable docker"
    fi
    show_success "Docker instalado."
    
    show_info "Inicializando Docker Swarm..."
    execute "docker swarm init --advertise-addr $(hostname -I | awk '{print $1}') || true"
    show_success "Docker Swarm inicializado."
    
    show_info "Creando redes overlay frontend y backend..."
    execute "docker network create --driver overlay --scope swarm frontend || true"
    execute "docker network create --driver overlay --scope swarm backend || true"
    show_success "Redes Docker Swarm creadas."
}

# ------------------------------
# 3. Función de Despliegue y Sustitución Segura
# ------------------------------
substitute_and_deploy_tool() {
    local tool_name="$1"
    local subdomain="${SUBDOMAINS[$tool_name]}"
    local stack_url="${STACK_URLS[$tool_name]}"
    local tool_dir="$DOCKER_DIR/$tool_name"
    local stack_file="$tool_dir/$tool_name-stack.yml"
    local deploy_file="$tool_dir/$tool_name-deploy.yml"

    # Crear directorios
    execute "mkdir -p \"$tool_dir\""
    
    # Descargar plantilla
    show_info "Descargando plantilla para $tool_name desde GitHub..."
    if ! curl -fsSL "$stack_url" -o "$stack_file"; then
        show_error "No se pudo descargar la plantilla de $tool_name. Verifique la URL: $stack_url"
    fi

    # Copiar para despliegue
    execute "cp \"$stack_file\" \"$deploy_file\""
    
    # 💥 SUSTITUCIÓN SEGURA: Usamos 'sed' con comillas dobles forzadas
    show_info "Sustituyendo variables de entorno con sintaxis YAML segura..."

    # Sustituir Contraseña y Clave Secreta, FORZANDO COMILLAS DOBLES
    execute "sed -i 's#REPLACE_PASSWORD#\"$COMMON_PASSWORD\"#g' \"$deploy_file\""
    execute "sed -i 's#REPLACE_SECRET_KEY#\"$SECRET_KEY\"#g' \"$deploy_file\""

    # Sustituir Dominio y Subdominio (para URLs de Traefik)
    execute "sed -i 's#REPLACE_SUBDOMAIN#$subdomain#g' \"$deploy_file\""
    execute "sed -i 's#REPLACE_DOMAIN#$BASE_DOMAIN#g' \"$deploy_file\""
    
    show_success "Variables de $tool_name sustituidas."

    # Desplegar el stack
    show_info "Desplegando $tool_name en Docker Swarm..."
    execute "docker stack deploy -c \"$deploy_file\" \"$tool_name\""
    show_success "$tool_name instalado correctamente."

    # Pausa para BBDD
    if [ "$tool_name" = "postgres" ] || [ "$tool_name" = "redis" ]; then
        show_info "Esperando 15 segundos para estabilización de la BBDD..."
        sleep 15
    fi
}

# Función para la inicialización de Chatwoot
initialize_chatwoot_db() {
    show_info "Iniciando proceso de inicialización de la base de datos de Chatwoot..."
    
    local chatwoot_stack="chatwoot"
    local deploy_file="$DOCKER_DIR/$chatwoot_stack/$chatwoot_stack-deploy.yml"
    local init_stack_file="$DOCKER_DIR/$chatwoot_stack/chatwoot-db-init.yml"

    # Crear un stack temporal para la inicialización.
    # El archivo de despliegue principal debe contener un servicio para inicializar.
    
    # 1. Ejecutar db:setup y db:seed (Simulado de tu script original)
    show_info "Ejecutando setup y seed de la base de datos de Chatwoot..."
    
    execute "docker compose -f \"$deploy_file\" run --rm chatwoot rails db:chatwoot_setup"
    
    # 2. Eliminar cualquier residuo del stack temporal si es que se usó
    # execute "docker stack rm chatwoot-init || true"

    show_success "Inicialización de base de datos completada exitosamente."
}

# ------------------------------
# 4. Lógica Principal
# ------------------------------

# 4a. Ejecutar la instalación base
install_dependencies

# 4b. Instalar todas las herramientas
show_info "Iniciando despliegue de todos los servicios..."
for tool_name in "${ALL_TOOLS[@]}"; do
    substitute_and_deploy_tool "$tool_name"
    
    # Lógica de inicialización de Chatwoot
    if [ "$tool_name" = "chatwoot" ]; then
        # Después de desplegar el stack de Chatwoot, inicializar la BBDD
        show_info "Esperando 30 segundos a que el contenedor de Chatwoot inicie por primera vez..."
        sleep 30
        initialize_chatwoot_db
    fi
done

# ------------------------------
# 5. Resultados Finales
# ------------------------------

# Guardar credenciales en el archivo .env.global
show_info "Guardando credenciales en $DOCKER_DIR/.env.global..."
echo "COMMON_PASSWORD=$COMMON_PASSWORD" > "$DOCKER_DIR/.env.global"
echo "BASE_DOMAIN=$BASE_DOMAIN" >> "$DOCKER_DIR/.env.global"
echo "SECRET_KEY=$SECRET_KEY" >> "$DOCKER_DIR/.env.global"

show_success "¡Instalación completada!"
echo ""
echo "Accede a tus servicios en los siguientes URLs:"
echo "- Traefik: https://${SUBDOMAINS[traefik]}.$BASE_DOMAIN"
echo "- Portainer: https://${SUBDOMAINS[portainer]}.$BASE_DOMAIN"
echo "- Redis: https://${SUBDOMAINS[redis]}.$BASE_DOMAIN"
echo "- Postgres: https://${SUBDOMAINS[postgres]}.$BASE_DOMAIN"
echo "- N8n: https://${SUBDOMAINS[n8n]}.$BASE_DOMAIN"
echo "- Evoapi: https://${SUBDOMAINS[evoapi]}.$BASE_DOMAIN"
echo "- Chatwoot: https://${SUBDOMAINS[chatwoot]}.$BASE_DOMAIN"
echo ""
echo "Información de credenciales:"
echo "- Contraseña común: $COMMON_PASSWORD"
echo "- Clave secreta: $SECRET_KEY"
echo ""
echo "Esta información se ha guardado en: $DOCKER_DIR/.env.global"
