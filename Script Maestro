#!/bin/bash

# ==============================================================================
# Script para la Instalación y Configuración de Herramientas Básicas de Seguridad
# ==============================================================================
#
# Este script instalará y configurará:
#   - Fail2Ban: Para protección contra ataques de fuerza bruta.
#   - RKHunter: Para la detección de rootkits y backdoors.
#   - CHKRootkit: Un escáner de rootkits complementario.
#   - UFW (Uncomplicated Firewall): Para gestionar las reglas del firewall.
#
# Se recomienda ejecutar este script en un sistema recién instalado.
#
# ==============================================================================

# --- Colores para los mensajes ---
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # Sin color

# --- Funciones para mostrar mensajes ---
show_message() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

show_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

show_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# --- Función Principal ---
main() {
    # 1. Verificar si el script se ejecuta como root
    if [ "$EUID" -ne 0 ]; then
        show_error "Este script debe ejecutarse como root. Por favor, utiliza 'sudo'."
        exit 1
    fi

    show_message "Iniciando la instalación de herramientas de seguridad..."
    
    # 2. Actualizar la lista de paquetes del sistema
    show_message "Actualizando la lista de paquetes (apt-get update)..."
    if ! apt-get update -y > /dev/null 2>&1; then
        show_error "Falló la actualización de la lista de paquetes. Verifica tu conexión a internet."
        exit 1
    fi
    show_success "Lista de paquetes actualizada."

    # --- Instalación de Fail2Ban ---
    show_message "Instalando y configurando Fail2Ban..."
    apt-get install -y fail2ban
    systemctl enable fail2ban
    systemctl start fail2ban
    show_success "Fail2Ban instalado y activado."

    # --- Instalación de RKHunter ---
    show_message "Instalando y configurando RKHunter..."
    # Pre-configurar debconf para evitar la pregunta de configuración de Postfix
    echo "postfix postfix/main_mailer_type select No configuration" | debconf-set-selections
    apt-get install -y rkhunter
    
    # Aplicar configuración a RKHunter
    local rkhunter_conf="/etc/rkhunter.conf"
    sed -i 's/^UPDATE_MIRRORS=.*/UPDATE_MIRRORS=1/' "$rkhunter_conf"
    sed -i 's/^MIRRORS_MODE=.*/MIRRORS_MODE=0/' "$rkhunter_conf"
    sed -i 's|^WEB_CMD=.*|WEB_CMD=\"\"|' "$rkhunter_conf"
    
    # Actualizar la base de datos de RKHunter
    rkhunter --update > /dev/null 2>&1
    rkhunter --propupd > /dev/null 2>&1
    show_success "RKHunter instalado y actualizado."
    
    # --- Instalación de CHKRootkit ---
    show_message "Instalando CHKRootkit..."
    apt-get install -y chkrootkit
    show_success "CHKRootkit instalado."
    
    # --- Configuración de UFW (Firewall) ---
    show_message "Configurando el firewall UFW..."
    apt-get install -y ufw
    ufw allow ssh   # Permitir conexiones SSH
    ufw allow http  # Permitir tráfico web HTTP
    ufw allow https # Permitir tráfico web HTTPS
    
    # Activar el firewall sin pedir confirmación
    echo "y" | ufw enable
    show_success "Firewall UFW configurado y activado."
    
    echo ""
    show_success "¡Configuración de seguridad completada!"
    echo "Resumen de lo realizado:"
    echo "  - Fail2Ban está activo para proteger contra fuerza bruta."
    echo "  - RKHunter y CHKRootkit están instalados para auditorías de seguridad."
    echo "  - El Firewall (UFW) está activado y permite tráfico SSH, HTTP y HTTPS."
}

# --- Ejecutar la función principal ---
main
