#!/usr/bin/env bash

# =================================================================================
# INSTALADOR AUTNOMO FINAL (v9.5.0 - FIX COMPLETO DE CHATWOOT)
# - Soluci贸n de inyecci贸n directa para errores de YAML.
# - Correcci贸n de la variable POSTGRES_USER a POSTGRES_USERNAME.
# =================================================================================

# ------------------------------
# 1. Configuraci贸n de Variables
# ------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# TUS VARIABLES (Hardcodeadas)
DOCKER_DIR="/home/docker"
COMMON_PASSWORD="Adel14881599"        
SECRET_KEY="wKStf8R8fAt7W78olV8D8kU5rdiqr31O"
BASE_DOMAIN="queennovedad.shop"

# Definici贸n de URLs (solo Chatwoot es relevante ahora)
declare -gA STACK_URLS=(
    [chatwoot]="https://github.com/user-attachments/files/22956465/chatwoot-stack.yml"
)
declare -gA SUBDOMAINS=(
    [chatwoot]="chat"
)

# ------------------------------
# 2. Funciones Auxiliares
# ------------------------------
show_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
show_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
show_error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
execute() { local cmd="$1"; show_info "-> Ejecutando: $cmd"; eval "$cmd"; local code=$?; if [ $code -ne 0 ]; then show_error "Comando fall贸 con c贸digo $code: $cmd"; fi; }

# Funci贸n de Despliegue de Chatwoot 
substitute_and_deploy_chatwoot() {
    local tool_name="chatwoot"
    local subdomain="${SUBDOMAINS[$tool_name]}"
    local stack_url="${STACK_URLS[$tool_name]}"
    local tool_dir="$DOCKER_DIR/$tool_name"
    local stack_file="$tool_dir/$tool_name-stack.yml"
    local deploy_file="$tool_dir/$tool_name-deploy.yml"

    show_info "Re-desplegando stack: $tool_name"
    
    execute "mkdir -p \"$tool_dir\""
    execute "mkdir -p \"$tool_dir/chatwoot_storage\""

    show_info "Descargando y sustituyendo plantilla para Chatwoot..."
    if ! curl -fsSL "$stack_url" -o "$stack_file"; then
        show_error "No se pudo descargar la plantilla de Chatwoot."
    fi
    execute "cp \"$stack_file\" \"$deploy_file\""
    execute "sed -i 's#REPLACE_PASSWORD#\"$COMMON_PASSWORD\"#g' \"$deploy_file\""
    execute "sed -i 's#REPLACE_SECRET_KEY#\"$SECRET_KEY\"#g' \"$deploy_file\""
    execute "sed -i 's#REPLACE_SUBDOMAIN#$subdomain#g' \"$deploy_file\""
    execute "sed -i 's#REPLACE_DOMAIN#$BASE_DOMAIN#g' \"$deploy_file\""
    show_success "Variables de Chatwoot sustituidas."

    show_info "Desplegando Chatwoot en Docker Swarm..."
    execute "docker stack deploy -c \"$deploy_file\" \"$tool_name\""
    show_success "Chatwoot instalado correctamente."
}

# ------------------------------
# 3. Funci贸n de Inicializaci贸n de Chatwoot (FIX V9.5.0 - Corregir Variable y YAML)
# ------------------------------
initialize_chatwoot_db() {
    show_info "Iniciando proceso de inicializaci贸n de la base de datos de Chatwoot..."
    
    local service_name="chatwoot_rails"

    show_info "Esperando 45 segundos para asegurar que el contenedor de Rails est茅 corriendo y PostgreSQL est茅 listo..."
    sleep 45

    show_info "Buscando ID del contenedor en ejecuci贸n para el servicio $service_name..."
    local container_id
    container_id=$(docker ps -q --filter name=${service_name} --format "{{.ID}}" | head -n 1)

    if [ -z "$container_id" ]; then
        show_error "No se encontr贸 ning煤n contenedor corriendo para el servicio $service_name."
    fi

    show_info "Contenedor ID encontrado: $container_id. Corrigiendo variable y ejecutando inicializaci贸n..."
    
    show_info "1/4: Sobreescribiendo /app/config/database.yml con POSTGRES_USERNAME (Inyecci贸n Directa)..."

    # FIX V9.5.0: Usar Here-Document literal y canalizar su contenido directamente.
    # Se usa POSTGRES_USERNAME para evitar el KeyError.
    if ! docker exec -i "$container_id" /bin/sh -c "cat > /app/config/database.yml" <<'YAML_CONTENT_LITERAL' ; then
production:
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  host: <%= ENV.fetch("POSTGRES_HOST") %>
  port: <%= ENV.fetch("POSTGRES_PORT") { 5432 } %>
  database: <%= ENV.fetch("POSTGRES_DATABASE") %>
  username: <%= ENV.fetch("POSTGRES_USERNAME") %> 
  password: <%= ENV.fetch("POSTGRES_PASSWORD") %>
YAML_CONTENT_LITERAL
        show_error "El paso de sobrescritura de database.yml fall贸."
    fi
    show_success "database.yml sobreescrito con 茅xito."

    # Comando 2: db:create (Crea la base de datos)
    show_info "2/4: Ejecutando db:create..."
    if ! docker exec -e RAILS_ENV=production "$container_id" /bin/sh -c "bundle exec rails db:create"; then
        show_error "db:create fall贸. No se pudo crear la base de datos."
    fi
    show_success "db:create completado."

    # Comando 3: db:migrate (Aplica las migraciones)
    show_info "3/4: Ejecutando db:migrate..."
    if ! docker exec -e RAILS_ENV=production "$container_id" /bin/sh -c "bundle exec rails db:migrate"; then
        show_error "db:migrate fall贸. No se pudieron aplicar las migraciones."
    fi
    show_success "db:migrate completado."

    # Comando 4: db:seed (Carga los datos iniciales, usuarios, etc.)
    show_info "4/4: Ejecutando db:seed..."
    if ! docker exec -e RAILS_ENV=production "$container_id" /bin/sh -c "bundle exec rails db:seed"; then
        show_error "db:seed fall贸. No se pudo cargar la configuraci贸n inicial."
    fi
    show_success "db:seed completado."
    
    show_success "Inicializaci贸n de base de datos completada exitosamente. Chatwoot deber铆a estar listo."
}


# ------------------------------
# 4. L贸gica Principal
# ------------------------------

# 1. Despliega el stack de Chatwoot
substitute_and_deploy_chatwoot 
# 2. Inicializa la base de datos con el parche
initialize_chatwoot_db 

# ------------------------------
# 5. Resultados Finales
# ------------------------------

show_success "隆Instalaci贸n de Chatwoot COMPLETADA! "
echo ""
echo "Accede a Chatwoot en: https://chat.$BASE_DOMAIN"
echo "Contrase帽a de base de datos/Redis: $COMMON_PASSWORD"
echo ""
