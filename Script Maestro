#!/usr/bin/env bash

# =================================================================================
# INSTALADOR AUTÓNOMO FINAL (v9.2.0 - SOLUCIÓN PARA ERROR YAML INTERNO DE CHATWOOT)
# Se sobrescribe el archivo database.yml defectuoso de la imagen de Chatwoot.
# =================================================================================

# ------------------------------
# 1. Configuración de Variables
# ------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# TUS VARIABLES (Hardcodeadas)
DOCKER_DIR="/home/docker"
COMMON_PASSWORD="Adel14881599"        
SECRET_KEY="wKStf8R8fAt7W78olV8D8kU5rdiqr31O"
BASE_DOMAIN="queennovedad.shop"

# Definición de URLs (solo Chatwoot es relevante ahora)
declare -gA STACK_URLS=(
    [chatwoot]="https://github.com/user-attachments/files/22956465/chatwoot-stack.yml"
)
declare -gA SUBDOMAINS=(
    [chatwoot]="chat"
)

# ------------------------------
# 2. Funciones Auxiliares
# ------------------------------
show_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
show_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
show_error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
execute() { local cmd="$1"; show_info "-> Ejecutando: $cmd"; eval "$cmd"; local code=$?; if [ $code -ne 0 ]; then show_error "Comando falló con código $code: $cmd"; fi; }

# Función de Despliegue de Chatwoot (solo para reejecución)
substitute_and_deploy_chatwoot() {
    local tool_name="chatwoot"
    local subdomain="${SUBDOMAINS[$tool_name]}"
    local stack_url="${STACK_URLS[$tool_name]}"
    local tool_dir="$DOCKER_DIR/$tool_name"
    local stack_file="$tool_dir/$tool_name-stack.yml"
    local deploy_file="$tool_dir/$tool_name-deploy.yml"

    show_info "Re-desplegando stack: $tool_name"
    
    # Crear directorios si es necesario
    execute "mkdir -p \"$tool_dir\""
    execute "mkdir -p \"$tool_dir/chatwoot_storage\""

    show_info "Descargando y sustituyendo plantilla para Chatwoot..."
    if ! curl -fsSL "$stack_url" -o "$stack_file"; then
        show_error "No se pudo descargar la plantilla de Chatwoot."
    fi
    execute "cp \"$stack_file\" \"$deploy_file\""
    execute "sed -i 's#REPLACE_PASSWORD#\"$COMMON_PASSWORD\"#g' \"$deploy_file\""
    execute "sed -i 's#REPLACE_SECRET_KEY#\"$SECRET_KEY\"#g' \"$deploy_file\""
    execute "sed -i 's#REPLACE_SUBDOMAIN#$subdomain#g' \"$deploy_file\""
    execute "sed -i 's#REPLACE_DOMAIN#$BASE_DOMAIN#g' \"$deploy_file\""
    show_success "Variables de Chatwoot sustituidas."

    show_info "Desplegando Chatwoot en Docker Swarm..."
    execute "docker stack deploy -c \"$deploy_file\" \"$tool_name\""
    show_success "Chatwoot instalado correctamente."
}

# ------------------------------
# 3. Función de Inicialización de Chatwoot (FIX V9.2.0 - Overwrite YAML)
# ------------------------------
initialize_chatwoot_db() {
    show_info "Iniciando proceso de inicialización de la base de datos de Chatwoot..."
    
    local service_name="chatwoot_rails"

    show_info "Esperando 45 segundos para asegurar que el contenedor de Rails esté corriendo y PostgreSQL esté listo..."
    sleep 45

    show_info "Buscando ID del contenedor en ejecución para el servicio $service_name..."
    local container_id
    container_id=$(docker ps -q --filter name=${service_name} --format "{{.ID}}" | head -n 1)

    if [ -z "$container_id" ]; then
        show_error "No se encontró ningún contenedor corriendo para el servicio $service_name."
    fi

    show_info "Contenedor ID encontrado: $container_id. Aplicando FIX de YAML e inicializando DB..."
    
    # FIX V9.2.0: Escribir un database.yml válido para sobreescribir el defectuoso
    # Este YAML lee las variables de entorno que ya pasamos en el docker stack.
    local yaml_content="production:\n  adapter: postgresql\n  encoding: unicode\n  pool: <%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %>\n  host: <%= ENV.fetch(\"POSTGRES_HOST\") %>\n  port: <%= ENV.fetch(\"POSTGRES_PORT\") { 5432 } %>\n  database: <%= ENV.fetch(\"POSTGRES_DATABASE\") %>\n  username: <%= ENV.fetch(\"POSTGRES_USER\") %>\n  password: <%= ENV.fetch(\"POSTGRES_PASSWORD\") %>"
    
    show_info "1/4: Sobreescribiendo /app/config/database.yml con una configuración mínima válida..."
    # Inyectamos la configuración YAML usando printf y /bin/sh
    if ! docker exec "$container_id" /bin/sh -c "printf \"$yaml_content\" > /app/config/database.yml"; then
        show_error "El paso de sobrescritura de database.yml falló."
    fi
    show_success "database.yml sobreescrito con éxito."

    # Comando 2: db:create (Crea la base de datos)
    show_info "2/4: Ejecutando db:create..."
    if ! docker exec -e RAILS_ENV=production "$container_id" /bin/sh -c "bundle exec rails db:create"; then
        show_error "db:create falló. No se pudo crear la base de datos."
    fi
    show_success "db:create completado."

    # Comando 3: db:migrate (Aplica las migraciones)
    show_info "3/4: Ejecutando db:migrate..."
    if ! docker exec -e RAILS_ENV=production "$container_id" /bin/sh -c "bundle exec rails db:migrate"; then
        show_error "db:migrate falló. No se pudieron aplicar las migraciones."
    fi
    show_success "db:migrate completado."

    # Comando 4: db:seed (Carga los datos iniciales, usuarios, etc.)
    show_info "4/4: Ejecutando db:seed..."
    if ! docker exec -e RAILS_ENV=production "$container_id" /bin/sh -c "bundle exec rails db:seed"; then
        show_error "db:seed falló. No se pudo cargar la configuración inicial."
    fi
    show_success "db:seed completado."
    
    show_success "Inicialización de base de datos completada exitosamente. Chatwoot debería estar listo."
}


# ------------------------------
# 4. Lógica Principal
# ------------------------------

substitute_and_deploy_chatwoot
initialize_chatwoot_db

# ------------------------------
# 5. Resultados Finales
# ------------------------------

show_success "¡Instalación de Chatwoot COMPLETADA! 🎉"
echo ""
echo "Accede a Chatwoot en: https://chat.$BASE_DOMAIN"
echo "Contraseña de base de datos/Redis: $COMMON_PASSWORD"
echo ""
